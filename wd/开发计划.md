# QtPlanArchitect 开发计划

**项目名称**: QtPlanArchitect (桌面端户型仿真设计软件)
**版本**: V1.0
**计划周期**: 8周
**技术栈**: Qt 6.8+, C++17, OpenGL 3.3+, MinGW 64-bit

---

## 阶段划分总览

| 阶段 | 时间 | 核心目标 | 关键交付物 |
|------|------|----------|-----------|
| 第一阶段 | Week 1 | 基础框架搭建 | 主窗口 + 可缩放画布 |
| 第二阶段 | Week 2 | 底图系统 + 基础墙体 | 底图导入 + 墙体绘制 |
| 第三阶段 | Week 3 | 3D 渲染基础 | 墙体 3D 显示 + 实时同步 |
| 第四阶段 | Week 4 | 智能墙体系统 | 墙体融合 + 吸附系统 |
| 第五阶段 | Week 5 | 门窗系统 | 门窗绘制 + 开洞逻辑 |
| 第六阶段 | Week 6 | 家具系统 | 家具库 + 拖拽放置 |
| 第七阶段 | Week 7 | 数据持久化 | 保存/加载 + 导出功能 |
| 第八阶段 | Week 8 | 优化与完善 | 性能优化 + Bug修复 |

---

## 第一阶段：基础框架搭建 (Week 1)

### 开发任务

#### 1.1 项目初始化
- [x] 创建 Qt 项目 (untitled.pro)
- [ ] 配置 C++17 标准
- [ ] 添加必要的 Qt 模块依赖 (Core, Gui, Widgets, OpenGL, OpenGLWidgets, Svg)
- [ ] 设置项目目录结构
  ```
  src/
  ├── main.cpp
  ├── mainwindow.h/cpp
  ├── designscene.h/cpp
  ├── view2dwidget.h/cpp
  └── (待添加)
  ```

#### 1.2 主窗口布局 (MainWindow)
- [ ] 实现菜单栏
  - 文件: 新建、打开、保存、另存为、退出
  - 编辑: 撤销、重做、删除
  - 视图: 网格、标尺、十字光标
  - 帮助: 关于
- [ ] 实现工具栏
  - 选择工具、墙体绘制、门窗放置、家具放置
  - 保存、撤销、重做按钮
- [ ] 实现左侧组件库面板 (QListWidget)
  - 墙体、门窗、家具分类
  - 暂时显示占位符
- [ ] 实现右侧属性面板 (QDockWidget)
  - 名称、宽度、高度、厚度输入框
  - 贴图选择器 (占位)
- [ ] 实现状态栏
  - 显示鼠标坐标 (X, Y)
  - 显示当前比例尺
  - 显示当前操作提示

#### 1.3 场景与视图系统
- [ ] 实现 DesignScene 类 (继承 QGraphicsScene)
  - 基础场景初始化
  - 设置场景坐标系统 (无限画布)
- [ ] 实现 View2DWidget 类 (继承 QGraphicsView)
  - 基础视图配置 (抗锯齿、视口更新模式)
  - 设置场景关联

#### 1.4 视图交互基础
- [ ] 实现缩放功能
  - 鼠标滚轮缩放
  - 以光标为中心缩放
  - 限制缩放范围 (0.1x - 10x)
- [ ] 实现平移功能
  - 鼠标中键拖拽
  - 空格键 + 左键拖拽
  - 边界无限延伸

#### 1.5 网格系统
- [ ] 实现网格绘制 (重写 drawBackground)
  - 小网格: 100mm x 100mm (浅灰色)
  - 大网格: 1000mm x 1000mm (深灰色)
  - 网格随缩放自适应显示/隐藏
- [ ] 实现标尺显示
  - 画布顶部和左侧显示刻度
  - 刻度随缩放自适应

### 测试目标

#### 功能测试
- [ ] **F1.1**: 应用程序正常启动，显示主窗口
- [ ] **F1.2**: 菜单栏、工具栏、侧边栏、状态栏布局正确
- [ ] **F1.3**: 鼠标滚轮缩放画布，缩放中心为鼠标位置
- [ ] **F1.4**: 中键拖拽或空格+左键平移画布流畅无卡顿
- [ ] **F1.5**: 网格在不同缩放级别下正确显示
- [ ] **F1.6**: 状态栏实时显示鼠标坐标 (误差 < 1mm)

#### 性能测试
- [ ] **P1.1**: 画布缩放响应时间 < 16ms (60fps)
- [ ] **P1.2**: 平移操作 CPU 占用率 < 30%

#### 兼容性测试
- [ ] **C1.1**: Windows 10 (1809+) 系统运行正常
- [ ] **C1.2**: Windows 11 系统运行正常
- [ ] **C1.3**: 不同 DPI 缩放 (100%, 125%, 150%) 下 UI 显示正确

---

## 第二阶段：底图系统 + 基础墙体 (Week 2)

### 开发任务

#### 2.1 底图导入系统
- [ ] 实现底图加载功能
  - 支持格式: JPG, PNG, BMP
  - 文件选择对话框
  - 图片加载到 Scene 背景
- [ ] 实现底图显示
  - 底图固定在最底层 (ZValue = -100)
  - 重写 drawBackground 绘制底图
- [ ] 实现透明度调节
  - 添加滑动条控件 (0% - 100%)
  - 实时更新底图透明度

#### 2.2 比例尺校准系统
- [ ] 实现校准模式
  - 添加 "比例尺校准" 工具按钮
  - 进入校准模式后,鼠标变为十字准星
- [ ] 实现校准交互
  - 用户在底图上点击两点画线
  - 显示测量线和长度标注
- [ ] 实现比例尺输入
  - 弹出对话框输入实际长度 (单位: mm)
  - 计算 pixelsPerMm = 像素长度 / 实际长度
  - 自动缩放底图到 1:1 坐标系
- [ ] 实现比例尺显示
  - 状态栏显示当前比例 (如 "1:50")
  - 标尺刻度根据比例尺自适应

#### 2.3 基础墙体绘制 (WallItem)
- [ ] 创建 WallItem 类
  - 继承 QGraphicsPolygonItem
  - 成员变量: startPos, endPos, thickness, height
- [ ] 实现墙体几何计算
  - updateGeometry() 方法
  - 根据起点、终点、厚度计算4个顶点
  - 生成 QPolygonF 并设置
- [ ] 实现墙体绘制模式
  - DesignScene 添加 Mode_DrawWall 模式
  - 左键点击确定起点
  - 鼠标移动显示临时墙体预览
  - 再次点击确定终点并创建墙体
  - 右键或 ESC 退出绘制模式
- [ ] 实现墙体渲染
  - paint() 方法绘制墙体填充和边框
  - 选中状态高亮显示 (蓝色边框 #1890FF)

#### 2.4 墙体属性管理
- [ ] 实现默认属性
  - 厚度: 240mm
  - 高度: 2800mm
  - 颜色: 浅灰色填充 (#F0F0F0)
- [ ] 实现属性修改
  - 选中墙体后右侧面板显示属性
  - 修改厚度/高度后实时更新墙体

#### 2.5 基础工具管理
- [ ] 实现 ToolManager 类
  - 管理工具状态切换 (Select, DrawWall)
  - 通过信号通知 Scene 模式变化
- [ ] 实现光标反馈
  - 选择模式: 默认箭头
  - 绘制模式: 十字准星
  - 移动到墙体边缘: 四向箭头

### 测试目标

#### 功能测试
- [ ] **F2.1**: 成功导入 JPG/PNG/BMP 底图,显示正确
- [ ] **F2.2**: 透明度滑动条调节底图透明度 (0-100%)
- [ ] **F2.3**: 比例尺校准流程完整可用
  - 画线 → 输入实际长度 → 底图自动缩放
- [ ] **F2.4**: 墙体绘制流程正常
  - 点击起点 → 移动鼠标显示预览 → 点击终点 → 墙体创建
- [ ] **F2.5**: 绘制的墙体形状正确 (矩形,厚度均匀)
- [ ] **F2.6**: 选中墙体后属性面板显示正确数值
- [ ] **F2.7**: 修改墙体厚度/高度后墙体立即更新

#### 精度测试
- [ ] **A2.1**: 比例尺计算误差 < 0.1%
- [ ] **A2.2**: 墙体顶点坐标精度 < 1mm
- [ ] **A2.3**: 墙体厚度实际值与设定值误差 < 0.5mm

#### 性能测试
- [ ] **P2.1**: 加载 4K 底图 (3840x2160) 耗时 < 2s
- [ ] **P2.2**: 绘制墙体时鼠标跟随无延迟 (< 16ms)
- [ ] **P2.3**: 场景中 50 个墙体时刷新帧率 ≥ 30fps

---

## 第三阶段：3D 渲染基础 (Week 3)

### 开发任务

#### 3.1 OpenGL 环境搭建
- [ ] 创建 View3DWidget 类
  - 继承 QOpenGLWidget
  - 继承 QOpenGLFunctions_3_3_Core
- [ ] 实现 OpenGL 初始化 (initializeGL)
  - 加载 OpenGL 函数指针
  - 设置清屏颜色
  - 启用深度测试
  - 创建 VAO/VBO

#### 3.2 着色器系统
- [ ] 创建基础着色器
  - 顶点着色器 (vertex shader)
    ```glsl
    in vec3 position;
    uniform mat4 model;
    uniform mat4 view;
    uniform mat4 projection;
    void main() {
        gl_Position = projection * view * model * vec4(position, 1.0);
    }
    ```
  - 片段着色器 (fragment shader)
    ```glsl
    uniform vec3 color;
    out vec4 FragColor;
    void main() {
        FragColor = vec4(color, 1.0);
    }
    ```
- [ ] 加载和编译着色器
  - 使用 QOpenGLShaderProgram
  - 错误检测和日志输出

#### 3.3 相机系统
- [ ] 实现相机参数
  - 位置 (Position): QVector3D
  - 目标点 (Target): QVector3D
  - 上方向 (Up): QVector3D(0, 1, 0)
- [ ] 实现观察矩阵 (View Matrix)
  - 使用 QMatrix4x4::lookAt()
- [ ] 实现投影矩阵 (Projection Matrix)
  - 透视投影: perspective(fov=45°, aspect, near=0.1, far=10000)
- [ ] 实现相机初始位置
  - 俯视角度: Position(0, 5000, 5000), Target(0, 0, 0)

#### 3.4 墙体 3D 网格生成
- [ ] 实现 WallItem::get3DVertices()
  - 从 2D Polygon 生成底部4个顶点 (Y=0)
  - 生成顶部4个顶点 (Y=height)
  - 返回 QVector<QVector3D>
- [ ] 实现墙体 Mesh 构建
  - 生成6个面的三角形 (12个三角形,36个顶点)
  - 顶点顺序: 逆时针 (CCW)
- [ ] 实现坐标转换
  - 2D_X → 3D_X
  - 2D_Y → 3D_Z
  - Wall_Height → 3D_Y

#### 3.5 3D 渲染循环 (paintGL)
- [ ] 实现渲染流程
  1. 清空颜色和深度缓冲
  2. 绑定着色器程序
  3. 设置 MVP 矩阵 uniform
  4. 遍历 scene->walls()
  5. 为每个墙体生成 Mesh
  6. 上传顶点数据到 VBO
  7. 调用 glDrawArrays(GL_TRIANGLES, ...)
  8. 释放着色器
- [ ] 实现墙体颜色
  - 默认: 浅灰色 (0.9, 0.9, 0.9)

#### 3.6 2D/3D 同步机制
- [ ] 连接信号槽
  - DesignScene::sceneContentChanged() → View3DWidget::onSceneChanged()
- [ ] 实现 onSceneChanged() 槽
  - 标记脏标志 (m_needsUpdate = true)
  - 调用 update() 触发重绘
- [ ] 性能优化
  - 延迟更新: 仅在 paintGL() 时重新生成网格
  - 避免频繁信号 (节流: 100ms)

#### 3.7 画中画 (PIP) 窗口
- [ ] 实现 3D 窗口布局
  - 在主窗口右上角创建悬浮窗口
  - 使用 QSplitter 或自定义布局
  - 默认大小: 400x300
- [ ] 实现窗口拖拽
  - 可调整大小
  - 可最小化/最大化

#### 3.8 基础 3D 交互
- [ ] 实现鼠标旋转 (Orbit)
  - 左键拖拽: 更新 yaw/pitch 角度
  - 限制 pitch 范围: [-89°, 89°]
- [ ] 实现鼠标缩放 (Zoom)
  - 滚轮: 调整相机距离
  - 限制距离范围: [500, 20000]

### 测试目标

#### 功能测试
- [ ] **F3.1**: 3D 窗口正常显示,无黑屏或闪烁
- [ ] **F3.2**: 绘制的墙体在 3D 视图中正确显示为立方体
- [ ] **F3.3**: 墙体高度、厚度与 2D 设置一致
- [ ] **F3.4**: 在 2D 视图添加/删除/移动墙体时,3D 视图实时同步 (< 100ms)
- [ ] **F3.5**: 左键拖拽旋转 3D 视角,流畅无卡顿
- [ ] **F3.6**: 滚轮缩放 3D 视角,距离限制生效

#### 精度测试
- [ ] **A3.1**: 墙体 3D 顶点坐标与 2D 计算坐标误差 < 1mm
- [ ] **A3.2**: 坐标转换正确: 2D(1000, 2000) → 3D(1000, 0, 2000)

#### 性能测试
- [ ] **P3.1**: 2D 修改后 3D 同步延迟 < 100ms
- [ ] **P3.2**: 10 个墙体时 3D 渲染帧率 ≥ 60fps
- [ ] **P3.3**: 50 个墙体时 3D 渲染帧率 ≥ 30fps
- [ ] **P3.4**: 3D 视角旋转响应时间 < 16ms

#### 视觉测试
- [ ] **V3.1**: 墙体渲染无 Z-fighting (深度冲突) 现象
- [ ] **V3.2**: 墙体边缘抗锯齿效果良好
- [ ] **V3.3**: 光照基本合理 (暂无光照系统,仅环境光)

---

## 第四阶段：智能墙体系统 (Week 4)

### 开发任务

#### 4.1 吸附系统 (Snap System)
- [ ] 创建 SnapEngine 类
  - 定义 SnapPoint 结构 (position, type, priority)
  - 类型: Endpoint, Midpoint, Perpendicular, Grid
- [ ] 实现吸附点收集
  - 收集所有墙体的端点 (priority=1.0)
  - 收集所有墙体的中点 (priority=2.0)
  - 收集网格点 (priority=3.0, 100mm 间距)
- [ ] 实现吸附算法
  - 按距离 + 优先级排序候选点
  - 返回容差范围内 (默认 10px) 的最佳点
- [ ] 集成到绘制流程
  - mouseMoveEvent 中调用 findBestSnap()
  - 吸附时显示视觉提示 (小圆圈)

#### 4.2 正交限制 (Shift 键)
- [ ] 检测 Shift 键状态
  - 在 keyPressEvent/keyReleaseEvent 中维护标志位
- [ ] 实现正交绘制
  - 计算鼠标相对起点的方向
  - 判断水平或垂直方向 (abs(dx) vs abs(dy))
  - 锁定另一轴坐标

#### 4.3 动态输入 (数字输入)
- [ ] 实现输入缓冲区
  - 维护字符串缓冲区存储输入的数字
- [ ] 实现键盘事件处理
  - 捕获数字键 (0-9) 和小数点
  - 回车键确认输入
  - ESC 键清空缓冲区
- [ ] 实现长度应用
  - 解析输入的长度值 (单位: mm)
  - 在鼠标方向生成指定长度的墙体
- [ ] 实现输入提示
  - 在光标附近显示当前输入值

#### 4.4 墙体智能连接
- [ ] 创建 WallJoinAlgorithm 类
  - 定义 JoinType 枚举: None, LCorner, TJunction
  - 定义 JoinResult 结构
- [ ] 实现连接检测
  - 计算端点间距离 (< SNAP_DISTANCE)
  - 计算两墙体夹角
- [ ] 实现 L 型连接 (90度)
  - 计算连接点 (两端点中点)
  - 计算内角点和外角点
  - 更新两墙体的 Polygon 顶点
- [ ] 实现 T 型连接
  - 检测端点是否在墙体中间
  - 计算垂足点
  - 分割被连接的墙体 (可选)
- [ ] 集成到墙体创建流程
  - finalizeWall() 中检测附近墙体
  - 调用 computeJoin() 并应用结果

#### 4.5 墙体编辑功能
- [ ] 实现墙体选中
  - 点击墙体时高亮显示
  - 显示控制点 (端点 Handle)
- [ ] 实现墙体移动
  - 拖拽墙体中部: 整体平移
  - 更新连接的墙体
- [ ] 实现墙体调整
  - 拖拽端点: 改变长度和方向
  - 保持厚度不变
  - 更新 Polygon
- [ ] 实现墙体删除
  - Delete 键或右键菜单删除
  - 断开所有连接

#### 4.6 多墙体管理
- [ ] 实现墙体列表
  - DesignScene 维护 QList<WallItem*>
- [ ] 实现墙体 ID 系统
  - 每个墙体分配唯一 ID (如 "w_1", "w_2")
- [ ] 实现连接关系管理
  - WallItem 维护 connectedWalls 列表
  - connectToWall() / disconnectFromWall() 方法

### 测试目标

#### 功能测试
- [ ] **F4.1**: 绘制墙体时鼠标靠近端点/中点/网格时自动吸附
- [ ] **F4.2**: 吸附时显示视觉提示 (圆圈或高亮)
- [ ] **F4.3**: 按住 Shift 键绘制墙体时,只能水平或垂直方向
- [ ] **F4.4**: 绘制时输入数字 (如 "3000") 并回车,生成 3000mm 长墙体
- [ ] **F4.5**: 输入数字时光标附近显示输入值
- [ ] **F4.6**: 两墙体端点接近时自动 L 型连接,无缝隙
- [ ] **F4.7**: 墙体端点吸附到墙体中间时 T 型连接
- [ ] **F4.8**: 选中墙体后显示蓝色边框和端点控制点
- [ ] **F4.9**: 拖拽墙体中部可整体移动墙体
- [ ] **F4.10**: 拖拽端点可调整墙体长度和方向
- [ ] **F4.11**: 删除墙体后相关连接自动断开

#### 精度测试
- [ ] **A4.1**: 吸附精度 < 1mm
- [ ] **A4.2**: 动态输入长度误差 < 0.1mm
- [ ] **A4.3**: L 型连接后角点坐标误差 < 0.5mm
- [ ] **A4.4**: 正交绘制时水平/垂直偏差 < 0.1°

#### 交互测试
- [ ] **I4.1**: 吸附响应时间 < 16ms (60fps)
- [ ] **I4.2**: Shift 键切换正交模式无延迟
- [ ] **I4.3**: 数字输入显示实时更新
- [ ] **I4.4**: 墙体拖拽流畅,无卡顿

#### 鲁棒性测试
- [ ] **R4.1**: 连续快速绘制 20 个墙体无崩溃
- [ ] **R4.2**: 删除已连接的墙体不导致悬空指针
- [ ] **R4.3**: 输入非法长度值 (如负数、超大数) 时有错误提示

---

## 第五阶段：门窗系统 (Week 5)

### 开发任务

#### 5.1 开洞图元基类 (OpeningItem)
- [ ] 创建 OpeningItem 类
  - 继承 QGraphicsItem
  - 成员变量: type (Door/Window), width, height, wallId, distanceFromStart
- [ ] 实现依附逻辑
  - 门窗必须关联到墙体 (wallId)
  - 记录在墙体上的位置 (distanceFromStart)
- [ ] 实现 boundingRect() 和 shape()
- [ ] 实现基础渲染
  - 绘制白色背景矩形 (遮挡墙体)
  - 绘制门窗符号

#### 5.2 门 (Door) 类型
- [ ] 创建 DoorItem 子类
  - 默认宽度: 900mm
  - 默认高度: 2100mm
- [ ] 实现门符号绘制
  - 绘制门框 (矩形)
  - 绘制门扇 (90度扇形弧线)
  - 开门方向箭头

#### 5.3 窗 (Window) 类型
- [ ] 创建 WindowItem 子类
  - 默认宽度: 1500mm
  - 默认高度: 1500mm
  - 默认离地高度: 900mm
- [ ] 实现窗符号绘制
  - 绘制窗框 (双线矩形)
  - 绘制窗格分隔线

#### 5.4 门窗库 (组件面板)
- [ ] 在左侧组件库添加门窗分类
  - 门类别: 单开门、双开门、推拉门
  - 窗类别: 平开窗、推拉窗、飘窗
- [ ] 实现缩略图显示
  - 使用 SVG 图标
  - 显示名称和尺寸

#### 5.5 门窗拖拽与吸附
- [ ] 实现拖拽开始
  - 从组件库拖拽门窗图标到画布
  - 创建临时 OpeningItem
- [ ] 实现墙体检测
  - 实时检测光标附近的墙体 (距离 < 50px)
  - 高亮显示目标墙体
- [ ] 实现自动旋转
  - 根据墙体方向自动旋转门窗
  - 垂直墙体: 0° 或 180°
  - 水平墙体: 90° 或 270°
- [ ] 实现吸附逻辑
  - 计算门窗在墙体上的投影位置
  - 吸附到墙体边缘或中点
- [ ] 实现放置确认
  - 释放鼠标时将门窗关联到墙体
  - 调用 wallItem->addOpening(opening)

#### 5.6 2D 开洞效果
- [ ] 实现图层顺序
  - 门窗 ZValue > 墙体 ZValue
- [ ] 实现遮挡绘制
  - paint() 中先绘制白色背景
  - 再绘制门窗符号
- [ ] 实现视觉效果
  - 门窗边缘阴影 (可选)
  - 开门方向标注

#### 5.7 3D 开洞算法
- [ ] 实现简化版分段渲染
  - 计算门窗在墙体上的位置区间 [start, end]
  - 渲染墙体段 [0, start]
  - 跳过 [start, end] (不渲染)
  - 渲染墙体段 [end, totalLength]
- [ ] 实现门窗 3D 模型
  - 门: 绘制门框 + 门板 (矩形体)
  - 窗: 绘制窗框 + 玻璃 (半透明)
- [ ] 处理多个开洞
  - 按位置排序所有 openings
  - 依次分段渲染

#### 5.8 门窗编辑
- [ ] 实现门窗选中
  - 点击门窗高亮显示
  - 属性面板显示门窗属性
- [ ] 实现门窗移动
  - 沿墙体方向拖拽
  - 限制在墙体范围内
  - 更新 distanceFromStart
- [ ] 实现门窗旋转
  - 显示旋转手柄
  - 仅支持 180° 翻转 (改变开门方向)
- [ ] 实现门窗删除
  - 从墙体的 openings 列表移除

### 测试目标

#### 功能测试
- [ ] **F5.1**: 从组件库拖拽门到画布,显示临时预览
- [ ] **F5.2**: 门靠近墙体时目标墙体高亮,门自动旋转对齐
- [ ] **F5.3**: 释放鼠标后门正确吸附到墙体上
- [ ] **F5.4**: 2D 视图中门窗符号正确显示,遮挡墙体线条
- [ ] **F5.5**: 3D 视图中墙体正确开洞,门窗模型显示
- [ ] **F5.6**: 一个墙体可以有多个门窗
- [ ] **F5.7**: 选中门窗后属性面板显示宽度、高度、类型
- [ ] **F5.8**: 拖拽门窗沿墙体移动,不能脱离墙体
- [ ] **F5.9**: 删除门窗后 2D/3D 视图同步更新

#### 精度测试
- [ ] **A5.1**: 门窗在墙体上的位置精度 < 1mm
- [ ] **A5.2**: 自动旋转角度误差 < 1°
- [ ] **A5.3**: 3D 开洞位置与 2D 吻合 (误差 < 2mm)

#### 交互测试
- [ ] **I5.1**: 拖拽门窗时实时预览流畅 (≥30fps)
- [ ] **I5.2**: 墙体检测响应时间 < 50ms
- [ ] **I5.3**: 门窗旋转动画流畅

#### 边界测试
- [ ] **B5.1**: 门窗宽度超过墙体长度时有错误提示
- [ ] **B5.2**: 两个门窗重叠时有警告提示
- [ ] **B5.3**: 墙体过短 (< 500mm) 时禁止添加门窗

---

## 第六阶段：家具系统 (Week 6)

### 开发任务

#### 6.1 资源管理器 (AssetManager)
- [ ] 实现单例模式
  - 全局唯一实例
- [ ] 定义 Asset 结构
  - id, name, category, svgPath, modelPath, defaultSize
- [ ] 实现资源加载
  - 从 assets/catalog.json 读取资源清单
  - 解析 JSON 数组
  - 填充 m_assets 哈希表
- [ ] 实现资源查询
  - getAsset(id): 根据 ID 获取资源
  - getAssetsByCategory(category): 按分类获取
- [ ] 创建资源目录结构
  ```
  assets/
  ├── catalog.json
  ├── icons/
  │   ├── sofa_01.svg
  │   ├── table_01.svg
  │   └── bed_01.svg
  └── models/
      ├── sofa_01.obj
      ├── table_01.obj
      └── bed_01.obj
  ```

#### 6.2 家具图元 (FurnitureItem)
- [ ] 创建 FurnitureItem 类
  - 继承 QGraphicsSvgItem
  - 成员变量: assetId, elevation, scale3D, rotation
- [ ] 实现 2D 显示
  - 加载 SVG 图标
  - 渲染在画布上
- [ ] 实现 3D 属性
  - elevation: 离地高度 (默认 0mm)
  - scale3D: 3D 缩放 (默认 1,1,1)
  - rotation: 旋转角度 (0-360°)
- [ ] 实现变换矩阵
  - transformMatrix() 方法
  - 组合平移、旋转、缩放矩阵

#### 6.3 家具库界面
- [ ] 扩展组件库面板
  - 添加家具分类: 客厅、卧室、厨房、卫浴
- [ ] 实现分类切换
  - QListWidget 或 QTreeWidget
  - 点击分类显示该类家具
- [ ] 实现家具列表
  - 显示缩略图 (SVG 预览)
  - 显示名称和默认尺寸
- [ ] 实现搜索功能 (可选)
  - 输入关键词过滤家具

#### 6.4 家具拖放
- [ ] 实现拖拽开始
  - 从家具库拖拽图标
  - 创建临时 FurnitureItem
- [ ] 实现拖拽预览
  - 跟随鼠标移动
  - 半透明显示 (opacity=0.5)
- [ ] 实现放置
  - 释放鼠标时固定位置
  - 添加到 Scene
- [ ] 实现碰撞检测 (可选)
  - 检测家具与墙体重叠
  - 重叠时显示红色边框警告

#### 6.5 家具编辑
- [ ] 实现家具移动
  - 拖拽家具主体: 平移
  - 实时更新位置
- [ ] 实现家具旋转
  - 选中后显示旋转手柄 (圆形弧线)
  - 拖拽手柄旋转
  - 支持 45° 吸附 (0°, 45°, 90°, ...)
- [ ] 实现家具缩放
  - 显示四角缩放手柄
  - 拖拽手柄调整大小
  - 支持锁定长宽比 (按住 Shift)
- [ ] 实现离地高度调节
  - 属性面板输入离地高度
  - 影响 3D 显示 (如吊灯、壁画)
- [ ] 实现家具删除
  - Delete 键删除选中家具

#### 6.6 3D 模型加载与渲染
- [ ] 集成 Assimp 库
  - 配置 CMakeLists.txt 或 .pro 文件
  - 链接 assimp 库
- [ ] 实现模型加载
  - loadModel(filePath) 方法
  - 支持 .obj, .glb 格式
  - 提取顶点、法线、纹理坐标
- [ ] 实现模型缓存
  - ModelCache 单例
  - 相同模型只加载一次
  - 使用 QSharedPointer 共享数据
- [ ] 实现模型渲染
  - 遍历 scene->furniture()
  - 获取缓存的 MeshData
  - 应用 transformMatrix()
  - 绘制到 3D 场景

#### 6.7 家具材质与颜色
- [ ] 实现默认材质
  - 木质: 棕色 (0.7, 0.5, 0.3)
  - 金属: 灰色 (0.5, 0.5, 0.5)
  - 布艺: 米色 (0.9, 0.85, 0.7)
- [ ] 实现材质选择 (可选)
  - 属性面板选择材质类型
  - 更新 3D 渲染颜色

### 测试目标

#### 功能测试
- [ ] **F6.1**: 启动时成功加载 catalog.json,家具库显示所有分类
- [ ] **F6.2**: 点击分类显示该类所有家具,缩略图正确
- [ ] **F6.3**: 拖拽家具到画布,显示半透明预览
- [ ] **F6.4**: 释放鼠标后家具固定在画布上,2D SVG 显示正确
- [ ] **F6.5**: 3D 视图中家具模型正确显示,位置与 2D 一致
- [ ] **F6.6**: 选中家具后显示移动/旋转/缩放手柄
- [ ] **F6.7**: 拖拽家具可移动,拖拽旋转手柄可旋转
- [ ] **F6.8**: 拖拽缩放手柄可改变大小,按住 Shift 锁定比例
- [ ] **F6.9**: 修改离地高度后 3D 模型垂直位置变化
- [ ] **F6.10**: 删除家具后 2D/3D 视图同步更新

#### 资源测试
- [ ] **R6.1**: 成功加载 10+ 家具模型无崩溃
- [ ] **R6.2**: catalog.json 格式错误时有友好提示
- [ ] **R6.3**: 模型文件缺失时使用占位符显示

#### 性能测试
- [ ] **P6.1**: 加载 catalog.json (100+ 家具) 耗时 < 1s
- [ ] **P6.2**: 场景中 20 个家具时 3D 渲染帧率 ≥ 30fps
- [ ] **P6.3**: 拖拽家具时鼠标跟随延迟 < 30ms

#### 精度测试
- [ ] **A6.1**: 家具 2D 位置与 3D 位置误差 < 5mm
- [ ] **A6.2**: 旋转角度精度 < 1°
- [ ] **A6.3**: 缩放比例精度 < 0.01

#### 交互测试
- [ ] **I6.1**: 旋转手柄 45° 吸附明显
- [ ] **I6.2**: 缩放时视觉反馈流畅
- [ ] **I6.3**: 家具拖拽响应流畅

---

## 第七阶段：数据持久化 (Week 7)

### 开发任务

#### 7.1 JSON 序列化系统
- [ ] 实现 DesignScene::toJson()
  - 生成 project_info 对象 (version, created_at)
  - 生成 settings 对象 (background_image, pixel_ratio, opacity)
  - 遍历 walls 生成 walls 数组
  - 遍历 openings 生成 openings 数组
  - 遍历 furniture 生成 furniture 数组
  - 返回 QJsonObject
- [ ] 实现图元序列化
  - WallItem::toJson(): id, start, end, thickness, height
  - OpeningItem::toJson(): type, wall_id, distance_from_start, width, height
  - FurnitureItem::toJson(): model_id, pos, rotate, scale, elevation
- [ ] 实现 DesignScene::fromJson()
  - 解析 JSON 对象
  - 恢复 settings
  - 重建 walls
  - 重建 openings (关联到墙体)
  - 重建 furniture
- [ ] 实现图元反序列化
  - WallItem::fromJson(json): 创建新实例
  - OpeningItem::fromJson(json)
  - FurnitureItem::fromJson(json)

#### 7.2 项目管理器 (ProjectManager)
- [ ] 实现单例模式
- [ ] 实现当前项目状态
  - 当前文件路径
  - 是否已修改 (isDirty)
- [ ] 实现修改追踪
  - Scene 修改时设置 isDirty = true
  - 保存后设置 isDirty = false
- [ ] 实现关闭提示
  - 如果 isDirty,询问是否保存

#### 7.3 保存功能
- [ ] 实现 "保存" (Save)
  - 如果有当前文件路径,直接保存
  - 否则调用 "另存为"
- [ ] 实现 "另存为" (Save As)
  - 显示文件保存对话框
  - 文件过滤器: "*.qplan"
  - 默认文件名: "未命名.qplan"
  - 调用 scene->toJson()
  - 写入文件 (QJsonDocument)
  - 更新当前文件路径
- [ ] 实现保存进度提示
  - 保存大文件时显示进度条 (可选)
- [ ] 实现快捷键
  - Ctrl+S: 保存
  - Ctrl+Shift+S: 另存为

#### 7.4 打开功能
- [ ] 实现 "打开" (Open)
  - 检查当前项目是否已修改,提示保存
  - 显示文件打开对话框
  - 文件过滤器: "*.qplan"
  - 读取文件内容
  - 解析 JSON (QJsonDocument)
  - 调用 scene->fromJson()
  - 更新当前文件路径
- [ ] 实现打开错误处理
  - 文件不存在: 错误提示
  - JSON 格式错误: 详细错误信息
  - 版本不兼容: 警告提示
- [ ] 实现快捷键
  - Ctrl+O: 打开

#### 7.5 新建功能
- [ ] 实现 "新建" (New)
  - 检查当前项目是否已修改,提示保存
  - 清空 Scene (clear())
  - 重置所有设置
  - 清空当前文件路径
- [ ] 实现快捷键
  - Ctrl+N: 新建

#### 7.6 最近文件列表
- [ ] 实现最近文件记录
  - 使用 QSettings 存储路径列表
  - 最多 10 个
- [ ] 实现菜单显示
  - 文件菜单显示最近文件
  - 点击快速打开
- [ ] 实现无效路径清理
  - 文件不存在时从列表移除

#### 7.7 导出功能
- [ ] 实现导出为图片
  - 渲染 2D 场景到 QImage
  - 支持格式: PNG, JPG, BMP
  - 支持自定义分辨率 (如 4K)
- [ ] 实现导出为 PDF (可选)
  - 使用 QPdfWriter
  - 包含比例尺和标注
- [ ] 实现导出为 DXF (可选,高级)
  - 墙体导出为线段
  - 门窗导出为块
  - 需集成 dxflib 或自行实现

#### 7.8 自动保存
- [ ] 实现自动保存定时器
  - 每 5 分钟自动保存
  - 保存到临时文件 (如 ".autosave.qplan")
- [ ] 实现崩溃恢复
  - 启动时检测是否有自动保存文件
  - 提示用户恢复

### 测试目标

#### 功能测试
- [ ] **F7.1**: 创建项目 → 添加墙体/门窗/家具 → 保存为 .qplan 文件
- [ ] **F7.2**: 打开已保存的 .qplan 文件,所有内容正确恢复
- [ ] **F7.3**: 修改项目后关闭,提示 "是否保存更改"
- [ ] **F7.4**: Ctrl+S 快捷键快速保存
- [ ] **F7.5**: Ctrl+N 新建项目清空画布
- [ ] **F7.6**: 文件菜单显示最近打开的文件
- [ ] **F7.7**: 导出为 PNG 图片,分辨率正确
- [ ] **F7.8**: 自动保存生成临时文件,崩溃后可恢复

#### 数据完整性测试
- [ ] **D7.1**: 保存 100 个墙体的项目,打开后数量和属性一致
- [ ] **D7.2**: 门窗与墙体的关联关系正确恢复
- [ ] **D7.3**: 家具的位置、旋转、缩放精确恢复 (误差 < 0.1%)
- [ ] **D7.4**: 底图路径、比例尺、透明度正确恢复

#### 兼容性测试
- [ ] **C7.1**: 不同版本的 .qplan 文件兼容处理
- [ ] **C7.2**: JSON 格式错误时不崩溃,友好提示
- [ ] **C7.3**: 文件路径包含中文/特殊字符时正常保存/加载

#### 性能测试
- [ ] **P7.1**: 保存 1000 个图元的项目耗时 < 2s
- [ ] **P7.2**: 打开 1000 个图元的项目耗时 < 3s
- [ ] **P7.3**: 导出 4K PNG 图片耗时 < 5s

#### 鲁棒性测试
- [ ] **R7.1**: 磁盘空间不足时保存失败有提示
- [ ] **R7.2**: 文件只读时无法保存有提示
- [ ] **R7.3**: 打开过程中按 ESC 可取消

---

## 第八阶段：优化与完善 (Week 8)

### 开发任务

#### 8.1 性能优化
- [ ] 实现场景剔除 (Frustum Culling)
  - 计算 3D 视锥体
  - 仅渲染可见对象
- [ ] 实现批量渲染
  - 合并所有墙体为一个大 Mesh
  - 减少 Draw Call 次数
- [ ] 实现模型 LOD (Level of Detail)
  - 远距离使用低面数模型
  - 近距离使用高面数模型
- [ ] 优化 2D 渲染
  - 使用 QGraphicsView 的缓存机制
  - 限制重绘区域 (setBoundingRegionGranularity)
- [ ] 优化内存使用
  - 使用对象池复用图元
  - 及时释放未使用的资源

#### 8.2 撤销/重做系统
- [ ] 实现 QUndoStack
- [ ] 创建命令类
  - AddWallCommand
  - DeleteWallCommand
  - MoveItemCommand
  - RotateItemCommand
  - ChangePropertyCommand
- [ ] 集成到操作流程
  - 每次修改操作 push 命令到栈
- [ ] 实现 UI 绑定
  - 撤销/重做按钮
  - 快捷键 Ctrl+Z / Ctrl+Y
  - 菜单项显示操作名称

#### 8.3 用户体验优化
- [ ] 实现操作提示
  - 状态栏实时显示当前操作
  - 如 "绘制墙体: 点击确定起点"
- [ ] 实现光标提示
  - 不同工具模式不同光标
  - 移动/调整大小/旋转光标
- [ ] 实现快捷键提示
  - 工具栏按钮显示快捷键
  - 帮助菜单显示快捷键列表
- [ ] 实现十字光标
  - 全屏十字辅助线
  - 随鼠标移动
  - 可切换显示/隐藏 (F12)

#### 8.4 3D 渲染增强
- [ ] 实现基础光照
  - 方向光 (太阳光)
  - 环境光 (ambient)
- [ ] 实现阴影 (可选)
  - Shadow Mapping
  - 仅地面阴影 (简化)
- [ ] 实现抗锯齿 (MSAA)
  - QSurfaceFormat 设置采样数
- [ ] 实现相机动画
  - 平滑过渡到目标视角
  - 缓动函数 (easing)

#### 8.5 辅助功能
- [ ] 实现测量工具
  - 点击两点测量距离
  - 显示尺寸标注
- [ ] 实现标注系统
  - 自动标注墙体长度
  - 自动标注房间面积
- [ ] 实现图层管理 (可选)
  - 墙体层、门窗层、家具层
  - 可单独显示/隐藏

#### 8.6 错误处理与日志
- [ ] 实现全局异常处理
  - 捕获未处理异常
  - 显示友好错误对话框
  - 记录到日志文件
- [ ] 实现日志系统
  - 使用 qDebug/qWarning/qCritical
  - 输出到文件 (logs/app.log)
  - 日志级别可配置
- [ ] 实现崩溃报告
  - 生成 minidump (Windows)
  - 上传到服务器 (可选)

#### 8.7 代码质量
- [ ] 代码审查
  - 检查内存泄漏 (使用 Valgrind 或 Dr. Memory)
  - 检查悬空指针
  - 检查未初始化变量
- [ ] 单元测试
  - 测试墙体几何计算
  - 测试吸附算法
  - 测试序列化/反序列化
  - 测试墙体连接算法
- [ ] 集成测试
  - 测试完整工作流
  - 测试保存/加载
  - 测试导出功能
- [ ] 性能测试
  - 压力测试 (1000+ 图元)
  - 内存占用测试
  - 渲染帧率测试

#### 8.8 文档编写
- [ ] 用户手册
  - 功能介绍
  - 操作教程 (配图)
  - 快捷键列表
  - 常见问题 (FAQ)
- [ ] 开发文档
  - 架构设计说明
  - API 文档 (Doxygen)
  - 构建指南
  - 贡献指南

#### 8.9 Bug 修复
- [ ] 收集已知 Bug 列表
- [ ] 按优先级修复
  - P0: 崩溃、数据丢失
  - P1: 功能不可用
  - P2: 功能异常但有 workaround
  - P3: UI 问题、体验优化
- [ ] 回归测试
  - 修复后重新测试相关功能

#### 8.10 发布准备
- [ ] 创建安装包
  - 使用 NSIS 或 Inno Setup (Windows)
  - 包含所有依赖库 (Qt DLL)
  - 包含资源文件 (assets/)
- [ ] 创建卸载程序
- [ ] 测试安装/卸载流程
- [ ] 准备发布说明
  - 版本号: V1.0
  - 发布日期
  - 主要功能
  - 已知问题

### 测试目标

#### 性能测试
- [ ] **P8.1**: 1000 个墙体 + 500 个家具时 2D 帧率 ≥ 30fps
- [ ] **P8.2**: 1000 个墙体 + 500 个家具时 3D 帧率 ≥ 20fps
- [ ] **P8.3**: 内存占用 < 500MB (中型项目)
- [ ] **P8.4**: 启动时间 < 3s

#### 稳定性测试
- [ ] **S8.1**: 连续运行 8 小时无崩溃
- [ ] **S8.2**: 连续 100 次保存/加载无内存泄漏
- [ ] **S8.3**: 压力测试: 10000 个图元无崩溃

#### 用户体验测试
- [ ] **U8.1**: 5 名新用户测试,平均 10 分钟内完成基础任务
- [ ] **U8.2**: 操作流畅,无明显卡顿或延迟
- [ ] **U8.3**: 错误提示友好,用户能理解

#### 代码质量测试
- [ ] **Q8.1**: 单元测试覆盖率 ≥ 60%
- [ ] **Q8.2**: 静态代码分析无严重问题
- [ ] **Q8.3**: 内存泄漏检测工具无报错

#### 发布测试
- [ ] **R8.1**: 安装包在干净系统上成功安装
- [ ] **R8.2**: 卸载后无残留文件 (除用户数据)
- [ ] **R8.3**: 用户手册完整,操作步骤正确

---

## 里程碑与验收标准

### Milestone 1: 基础框架完成 (Week 1)
**验收标准**:
- 主窗口布局完整,各面板正常显示
- 画布缩放/平移流畅
- 网格和标尺正确显示

### Milestone 2: 2D 功能完成 (Week 2-4)
**验收标准**:
- 底图导入和比例尺校准可用
- 墙体绘制、编辑、连接正常
- 吸附系统工作正常

### Milestone 3: 3D 渲染完成 (Week 3)
**验收标准**:
- 3D 视图正确显示墙体
- 2D/3D 同步延迟 < 100ms
- 相机交互流畅

### Milestone 4: 门窗系统完成 (Week 5)
**验收标准**:
- 门窗可拖拽放置到墙体
- 2D 遮挡效果正确
- 3D 开洞效果正确

### Milestone 5: 家具系统完成 (Week 6)
**验收标准**:
- 家具库正常显示
- 家具可拖拽、旋转、缩放
- 3D 模型正确加载和渲染

### Milestone 6: 数据持久化完成 (Week 7)
**验收标准**:
- 保存/加载功能正常
- 数据完整性 100%
- 导出功能可用

### Milestone 7: 产品发布 (Week 8)
**验收标准**:
- 性能达标 (P8.1-P8.4)
- 稳定性测试通过 (S8.1-S8.3)
- 安装包可用
- 文档完整

---

## 风险与应对

### 风险 1: OpenGL 兼容性问题
**概率**: 中
**影响**: 高
**应对**: 提供 OpenGL 版本检测,低版本降级到 2D-only 模式

### 风险 2: 墙体连接算法复杂度
**概率**: 高
**影响**: 中
**应对**: 简化算法,仅支持常见场景 (L型/T型),复杂情况手动调整

### 风险 3: 3D 模型加载性能
**概率**: 中
**影响**: 中
**应对**: 使用模型缓存,预加载常用模型,限制模型面数 (< 5000 三角形)

### 风险 4: JSON 文件体积过大
**概率**: 低
**影响**: 低
**应对**: 压缩 JSON (gzip),或使用二进制格式 (如 CBOR)

### 风险 5: 内存泄漏
**概率**: 中
**影响**: 高
**应对**: 定期使用内存检测工具,代码审查关注智能指针使用

---

## 资源需求

### 开发人员
- **C++ 开发**: 1-2 人
- **UI/UX 设计**: 0.5 人 (兼职)
- **测试**: 1 人 (最后 2 周)

### 硬件
- **开发机**: Windows 10/11, 16GB RAM, 独立显卡 (支持 OpenGL 3.3+)
- **测试机**: 至少 2 台不同配置的 Windows 机器

### 软件
- Qt 6.8+ (开源版或商业版)
- Qt Creator IDE
- CMake 或 QMake
- Git 版本控制
- Assimp 库
- (可选) Valgrind, Dr. Memory, Doxygen

---

## 总结

本开发计划分 8 个阶段,每个阶段都有明确的开发任务和测试目标。按照此计划执行,预计 8 周内完成 QtPlanArchitect V1.0 的开发和发布。

**关键成功因素**:
1. 严格按阶段推进,避免功能蔓延
2. 每个阶段结束后进行充分测试
3. 及时处理技术风险
4. 保持代码质量和文档同步更新

**后续版本规划** (V1.1+):

- AI 辅助设计 (自动布局)
